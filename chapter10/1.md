##<center>rest-framework实现用户认证</center>

### 一、创建数据模型

* 1、创建一个用户表

  ```py
  class UserModel(models.Model):
      """
      创建一个用户表
      """
      user_type_choices = (
          (1, '普通用户'),
          (2, 'VIP用户')
      )
      user_type = models.IntegerField(choices=user_type_choices, null=False, verbose_name='用户类型')
      username = models.CharField(max_length=100, null=False, verbose_name='用户名')
      password = models.CharField(max_length=100, null=False, verbose_name='密码')
  ```

* 2、创建`token`表

  ```py
  class UserTokenModel(models.Model):
      """
      创建一个用户token表
      """
      user = models.OneToOneField(to='UserModel', on_delete=models.CASCADE)
      token = models.CharField(max_length=100, verbose_name='用户token')
  ```

* 3、生成表
* 4、手动插入两条数据

### 二、原生的用户登录拦截(和第四章的`session`差不多)
* 1、进行`token`认证

  ```py
  class OrderView(APIView):
      def get(self, request, *args, **kwargs):
          res = {'code': 0, 'message': 'success'}
          token = request.GET.get('token', None)
          if token and models.UserTokenModel.objects.filter(token=token).first():
              try:
                  res['data'] = {'name': '哈哈'}
              except Exception as e:
                  print(e)
          else:
              res['code'] = 1
              res['message'] = '失败'
          return JsonResponse(res)
  ```

### 三、局部使用`rest-framework`的认证模块

* 1、导包

  ```py
  from rest_framework.authentication import BasicAuthentication
  from rest_framework import exceptions
  ```

* 2、认证类

  ```py
  class Authentication(BasicAuthentication):
      def authenticate(self, request):
          token = request.GET.get('token', None)
          token_obj = models.UserTokenModel.objects.filter(token=token).first()
          if not token_obj:
              raise exceptions.AuthenticationFailed('用户认证失败')
          return (token_obj.user, token_obj)
  ```

* 3、使用认证类(在需要认证的视图中写上)

  ```py
  class OrderView(APIView):
      authentication_classes = [Authentication]

      def get(self, request, *args, **kwargs):
          # 因为上面认证类中返回了,这里可以直接获取到
          print(request.user.username)
          print(request.auth)
          res = {'code': 1, 'message': '失败', 'data': None}
          try:
              res['data'] = {'name': '哈哈'}
          except Exception as e:
              print(e)
          return JsonResponse(res)
  ```